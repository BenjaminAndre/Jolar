# C'est un workflow de base qui est déclenché manuellement

name: Déploiement Indev vers itch.io

on:
  # S'exécute lors des pushs ciblant la branche par défaut
  push:
    branches: ["main"]
  # Permet d'exécuter ce workflow manuellement depuis l'onglet Actions
  workflow_dispatch:

# Un workflow est constitué d'un ou plusieurs jobs qui peuvent s'exécuter séquentiellement ou en parallèle
jobs:
  # Ce workflow contient un seul job appelé "deploy"
  deploy:
   # Always use ubuntu-latest for this action
    runs-on: ubuntu-latest
    # Add permission for release creation. Can be made narrower according to your needs
    permissions: write-all
    # Job name, can be anything
    name: Export Game
    strategy:
      fail-fast: true
      matrix:
        channel:
          - channel
    steps:
      # Always include the checkout step so that 
      # your project is available for Godot to export
    - name: checkout
      uses: actions/checkout@v4
  
    - name: export game
      id: export
      # Use latest version (see releases for all versions)
      uses: firebelley/godot-export@v6.0.0
      with:
        # Defining all the required inputs
        godot_executable_download_url: https://github.com/godotengine/godot/releases/download/4.3-stable/Godot_v4.3-stable_linux.x86_64.zip
        godot_export_templates_download_url: https://github.com/godotengine/godot-builds/releases/download/4.3-stable/Godot_v4.3-stable_export_templates.tpz
        relative_project_path: ./
        relative_export_path : bin/
        archive_output: true

      # This release action has worked well for me. However, you can most likely use any release action of your choosing.
      # https://github.com/ncipollo/release-action
      # I don't need a release on GH when I can just push to Itch
 #   - name: create release
  #    uses: ncipollo/release-action@v1.14.0
   #   with:
    #    token: ${{ secrets.GITHUB_TOKEN }}
     #   generateReleaseNotes: true
      #  tag: indev
       # artifacts: ${{ steps.export.outputs.archive_directory }}/*
          
    - name: Push to Itch.io
      uses: KikimoraGames/itch-publish@v0.0.3
      with:
        butlerApiKey: ${{secrets.BUTLER_API_KEY}}
        gameData: bin/web
        itchUsername: ${{env.ITCH_USERNAME}}
        itchGameId: ${{ env.ITCH_GAME_ID }}
        buildChannel: ${{ matrix.channel }}